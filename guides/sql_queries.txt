-- Top heroes filter
WITH FilteredProfileSquads AS (
    SELECT *
    FROM dbo.profile_squads
    WHERE Age Like '%Roman%' and Level >=80 and Level < 100
),
     LatestTimestamps AS (
         SELECT PlayerId, MAX(CollectedAt) AS LatestCollectedAt
         FROM FilteredProfileSquads
         GROUP BY PlayerId
     ),
     LatestUnits AS (
         SELECT fps.UnitId
         FROM FilteredProfileSquads fps
                  JOIN LatestTimestamps lt
                       ON fps.PlayerId = lt.PlayerId AND fps.CollectedAt = lt.LatestCollectedAt
     )
SELECT UnitId, COUNT(*) AS Count
FROM LatestUnits
GROUP BY UnitId
ORDER BY Count DESC
OFFSET 0 ROWS FETCH NEXT 20 ROWS ONLY;



-- Db stats
CREATE TABLE #SpaceUsed
(
    TableName  NVARCHAR(128),
    Rows       BIGINT,
    Reserved   VARCHAR(50),
    Data       VARCHAR(50),
    Index_Size VARCHAR(50),
    Unused     VARCHAR(50)
);
-- List your tables
DECLARE @TableName NVARCHAR(128);
DECLARE TableCursor CURSOR FOR
    SELECT name
    FROM sys.tables
    WHERE name IN ('alliances', 'battles', 'profile_squads', 'pvp_battles', 'player_city_snapshots',
                   'player_city_snapshot_data', 'players', 'battle_stats', 'battle_timelines', 'battle_squads',
                   'profile_squad_data', 'player_rankings', 'pvp_rankings2', 'alliance_rankings', 'alliance_members',
                   'player_name_history_entries', 'alliance_ath_rankings', 'pvp_battle_teams', 'battle_squad_stats',
				   'event_city_snapshots', 'event_city_snapshot_data')
    ORDER BY name;
OPEN TableCursor;
FETCH NEXT FROM TableCursor INTO @TableName;
WHILE @@FETCH_STATUS = 0
    BEGIN
        INSERT INTO #SpaceUsed EXEC sp_spaceused @TableName;
        FETCH NEXT FROM TableCursor INTO @TableName;
    END;
CLOSE TableCursor;
DEALLOCATE TableCursor;
-- DB space used
SELECT TableName,
       Rows,
       CAST(ROUND(CAST(REPLACE(Reserved, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2))   AS Reserved_MB,
       CAST(ROUND(CAST(REPLACE(Data, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2))       AS Data_MB,
       CAST(ROUND(CAST(REPLACE(Index_Size, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2)) AS Index_Size_MB,
       CAST(ROUND(CAST(REPLACE(Unused, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2))     AS Unused_MB
FROM #SpaceUsed
ORDER BY TableName;
DROP TABLE #SpaceUsed;



-- Run this to see which indexes are unused:
SELECT object_name(s.[object_id]) AS TableName,
       i.name                     AS IndexName,
       s.user_seeks,
       s.user_scans,
       s.user_lookups,
       s.user_updates
FROM sys.dm_db_index_usage_stats s
         JOIN sys.indexes i
              ON s.object_id = i.object_id AND s.index_id = i.index_id
ORDER BY s.user_seeks + s.user_scans + s.user_lookups;


-- Find queries doing table/index scans
SELECT TOP 20
    SUBSTRING(qt.text, 1, 200) AS query_text,
    qs.execution_count,
    qs.total_logical_reads,
    qp.query_plan
FROM sys.dm_exec_query_stats qs
         CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt
         CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp
WHERE qt.text LIKE '%players%'
  AND CAST(qp.query_plan AS NVARCHAR(MAX)) LIKE '%Scan%'  -- Plans with scans
ORDER BY qs.total_logical_reads DESC;



-- Real-time monitor
SELECT
    r.session_id,
    r.command,
    r.status,
    r.percent_complete,
    r.total_elapsed_time / 1000 AS elapsed_seconds,
    r.estimated_completion_time / 1000 AS est_seconds_remaining,
    r.wait_type,
    r.wait_time / 1000 AS wait_seconds,
    r.blocking_session_id,
    r.cpu_time / 1000 AS cpu_seconds,
    r.logical_reads,
    r.writes
FROM sys.dm_exec_requests r
ORDER BY r.session_id;



-- check stats
SET STATISTICS IO ON;
SET STATISTICS TIME ON;
-- your query here
SET STATISTICS IO OFF;
SET STATISTICS TIME OFF;


ALTER INDEX ALL ON battle_timelines REBUILD;


ALTER INDEX ALL ON battle_timelines REORGANIZE;


-- LOB and in-row space used
SELECT
    i.name AS IndexName,
    i.type_desc,
    p.data_compression_desc,
    p.rows,
    (ps.reserved_page_count * 8) / 1024.0 AS ReservedMB,
    (ps.used_page_count * 8) / 1024.0 AS UsedMB,
    (ps.in_row_data_page_count * 8) / 1024.0 AS InRowDataMB
FROM sys.indexes i
         INNER JOIN sys.partitions p ON i.object_id = p.object_id AND i.index_id = p.index_id
         INNER JOIN sys.dm_db_partition_stats ps ON p.object_id = ps.object_id AND p.index_id = ps.index_id AND p.partition_number = ps.partition_number
WHERE i.object_id = object_id('pvp_battle_teams');
SELECT
    SUM(ps.lob_used_page_count) * 8 / 1024.0 AS LOB_DataMB,
    SUM(ps.in_row_used_page_count) * 8 / 1024.0 AS InRowMB
FROM sys.dm_db_partition_stats ps
WHERE ps.object_id = object_id('pvp_battle_teams');


-- Check data sizes
SELECT
    AVG(DATALENGTH(Squads)) AS AvgBytes,
    MAX(DATALENGTH(Squads)) AS MaxBytes,
    COUNT(*) AS Count
FROM battle_squads;
