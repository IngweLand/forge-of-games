-- Top heroes filter
WITH FilteredProfileSquads AS (
    SELECT *
    FROM dbo.profile_squads
    WHERE Age Like '%Roman%' and Level >=80 and Level < 100
),
     LatestTimestamps AS (
         SELECT PlayerId, MAX(CollectedAt) AS LatestCollectedAt
         FROM FilteredProfileSquads
         GROUP BY PlayerId
     ),
     LatestUnits AS (
         SELECT fps.UnitId
         FROM FilteredProfileSquads fps
                  JOIN LatestTimestamps lt
                       ON fps.PlayerId = lt.PlayerId AND fps.CollectedAt = lt.LatestCollectedAt
     )
SELECT UnitId, COUNT(*) AS Count
FROM LatestUnits
GROUP BY UnitId
ORDER BY Count DESC
OFFSET 0 ROWS FETCH NEXT 20 ROWS ONLY;



-- Db stats
CREATE TABLE #SpaceUsed
(
    TableName  NVARCHAR(128),
    Rows       BIGINT,
    Reserved   VARCHAR(50),
    Data       VARCHAR(50),
    Index_Size VARCHAR(50),
    Unused     VARCHAR(50)
);
-- List your tables
DECLARE @TableName NVARCHAR(128);
DECLARE TableCursor CURSOR FOR
    SELECT name
    FROM sys.tables
    WHERE name IN ('alliances', 'battles', 'profile_squads', 'pvp_battles', 'player_city_snapshots',
                   'player_city_snapshot_data', 'players', 'battle_stats', 'battle_timelines', 'battle_squads',
                   'profile_squad_data', 'player_rankings', 'pvp_rankings2', 'alliance_rankings', 'alliance_members',
                   'player_name_history_entries', 'alliance_ath_rankings', 'pvp_battle_teams', 'battle_squad_stats')
    ORDER BY name;
OPEN TableCursor;
FETCH NEXT FROM TableCursor INTO @TableName;
WHILE @@FETCH_STATUS = 0
    BEGIN
        INSERT INTO #SpaceUsed EXEC sp_spaceused @TableName;
        FETCH NEXT FROM TableCursor INTO @TableName;
    END;
CLOSE TableCursor;
DEALLOCATE TableCursor;
-- DB space used
SELECT TableName,
       Rows,
       CAST(ROUND(CAST(REPLACE(Reserved, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2))   AS Reserved_MB,
       CAST(ROUND(CAST(REPLACE(Data, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2))       AS Data_MB,
       CAST(ROUND(CAST(REPLACE(Index_Size, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2)) AS Index_Size_MB,
       CAST(ROUND(CAST(REPLACE(Unused, ' KB', '') AS BIGINT) / 1024.0, 2) AS DECIMAL(18, 2))     AS Unused_MB
FROM #SpaceUsed
ORDER BY TableName;
DROP TABLE #SpaceUsed;



-- Run this to see which indexes are unused:
SELECT object_name(s.[object_id]) AS TableName,
       i.name                     AS IndexName,
       s.user_seeks,
       s.user_scans,
       s.user_lookups,
       s.user_updates
FROM sys.dm_db_index_usage_stats s
         JOIN sys.indexes i
              ON s.object_id = i.object_id AND s.index_id = i.index_id
ORDER BY s.user_seeks + s.user_scans + s.user_lookups;
