@implements IDisposable
@using Ingweland.Fog.Application.Client.Web.Analytics
@using Ingweland.Fog.Application.Client.Web.Analytics.Interfaces
@using Ingweland.Fog.Application.Client.Web.Constants
@using Ingweland.Fog.Application.Client.Web.Models
@using Ingweland.Fog.Application.Client.Web.Services.Abstractions
@using Ingweland.Fog.WebApp.Client.Services.Abstractions
@using Ingweland.Fog.WebApp.Client.Theme
@inherits LayoutComponentBase
@inject IPageMetadataService PageMetadataService
@inject IPersistenceService PersistenceService
<HeadContent>
    <meta name="description" content="@_pageMetadata.Description">
    <meta name="keywords" content="@_pageMetadata.Keywords">
</HeadContent>
<PageTitle>@_pageMetadata.PageTitle</PageTitle>
<MudThemeProvider Theme="FogTheme.Theme"/>
<MudPopoverProvider/>
<MudDialogProvider/>
<PageLoadingIndicator/>
<MudLayout Class="d-flex flex-column" Style="min-height: 100dvh">
    <NavBar/>
    <MudMainContent Class="main-layout-main-content">
        <ErrorBoundary>
            @if (_shouldShowAnnouncement)
            {
                <GlobalAnnouncementComponent OnAnnouncementConsumed="@(() => _shouldShowAnnouncement = false)"/>
            }
            @Body
        </ErrorBoundary>
    </MudMainContent>
</MudLayout>

@code
{
    private PageMetadata _pageMetadata = null!;
    private bool _shouldShowAnnouncement;

    [Inject]
    public NavigationManager NavigationManager { get; set; }
    
    [Inject]
    private IAnalyticsService AnalyticsService { get; set; }

    protected override void OnInitialized()
    {
        _pageMetadata = PageMetadataService.GetForCurrentPage();

        if (RendererInfo.IsInteractive)
        {
            NavigationManager.LocationChanged += NavigationManagerOnLocationChanged;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (OperatingSystem.IsBrowser())
        {
            var firstVisitAt = await PersistenceService.GetItemAsync<DateTime?>(PersistenceKeys.FIRST_VISIT_AT);
            if (firstVisitAt == null)
            {
                await PersistenceService.SetItemAsync(PersistenceKeys.FIRST_VISIT_AT, DateTime.UtcNow);
            }
        }

        await ShowNotification();
    }

    private async Task ShowNotification()
    {
        if (!OperatingSystem.IsBrowser())
        {
            return;
        }

        var now = DateTime.UtcNow;
        var firstVisitAt = await PersistenceService.GetItemAsync<DateTime?>(PersistenceKeys.FIRST_VISIT_AT);
        var donationNotificationReadAt = 
            await PersistenceService.GetItemAsync<DateTime?>(PersistenceKeys.DONATION_NOTIFICATION_READ_AT);
        var show = firstVisitAt < now.AddDays(-7) &&
            (donationNotificationReadAt == null || donationNotificationReadAt < now.AddDays(-30));
        if (_shouldShowAnnouncement != show)
        {
            _shouldShowAnnouncement = show;
            StateHasChanged();
            TrackEvent();
        }
    }
    
    private void TrackEvent()
    {
        if (!_shouldShowAnnouncement)
        {
            return;
        }
        
        var allParameters = new Dictionary<string, object>
        {
            [AnalyticsParams.ANNOUNCEMENT_ID] = "donation",
        };

        _ = AnalyticsService.TrackEvent(AnalyticsEvents.SHOW_ANNOUNCEMENT, allParameters);
    }

    private void NavigationManagerOnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _pageMetadata = PageMetadataService.GetForCurrentPage();
        StateHasChanged();
    }

    public void Dispose()
    {
        if (NavigationManager != null)
        {
            NavigationManager.LocationChanged -= NavigationManagerOnLocationChanged;
        }
    }
}
