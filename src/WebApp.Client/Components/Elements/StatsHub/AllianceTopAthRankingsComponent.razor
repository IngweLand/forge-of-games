@inject IStringLocalizer<FogResource> Loc
@using Ingweland.Fog.Application.Client.Core.Localization
@using Ingweland.Fog.Application.Client.Web.Services.Hoh.Abstractions
@using Ingweland.Fog.Application.Client.Web.StatsHub.ViewModels
@using Ingweland.Fog.Application.Core.Helpers
@using Ingweland.Fog.Dtos.Hoh
@using Ingweland.Fog.Models.Hoh.Enums
@using Microsoft.Extensions.Localization
@inherits StatsHubTopListComponentBase<Ingweland.Fog.Application.Client.Web.StatsHub.ViewModels.AllianceViewModel>
@{
    base.BuildRenderTree(__builder);
}

<style>
    .ath-button-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        align-items: center;
        justify-content: space-evenly;
        width: 100%;
        height: 52px;
        margin: 8px 0;
    }

    .ath-wrapper {
        align-self: center;
        justify-self: center;
    }
</style>

@code {

    protected override RenderFragment RenderItem(AllianceViewModel alliance) => __builder =>
    {
        <a class="anchor-inherited-style" href="@FogUrlBuilder.PageRoutes.Alliance(alliance.Id)">
            <AllianceListItemComponent Alliance="@alliance"/>
        </a>
    };

    protected override RenderFragment RenderBottomContainer() => __builder =>
    {
        if (_leagues != null)
        {
            <div class="ath-button-container" >
                <div class="ath-wrapper" >
                    <AthLeagueSelectorComponent Leagues="@_leagues" SelectedLeague="@_selectedLeague"
                                                LeagueChanged="@OnLeagueChanged"/>
                </div>
                <div class="ath-wrapper" >
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="margin-top: 4px"
                               Href="@ViewAllUrl">@Loc[FogResource.StatsHub_ViewAll]</MudButton>
                </div>
            </div>
        }
    };

    private TreasureHuntLeague _selectedLeague = TreasureHuntLeague.Overlord;

    [Inject]
    private ICommonUiService CommonUiService { get; set; }

    private IReadOnlyCollection<TreasureHuntLeagueDto>? _leagues;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (!OperatingSystem.IsBrowser())
        {
            return;
        }

        var result = await CommonUiService.GetTreasureHuntLeaguesAsync();
        _leagues = result.Values.Where(x => x.League != TreasureHuntLeague.Undefined).OrderBy(x => x.League)
            .ToList();
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if (!OperatingSystem.IsBrowser())
        {
            return;
        }

        await GetItemsAsync();
    }

    private async Task OnLeagueChanged(TreasureHuntLeague league)
    {
        _selectedLeague = league;
        await GetItemsAsync();
    }

    protected override async Task GetItemsAsync()
    {
        IsLoading = true;
        StateHasChanged();
        Items = await StatsHubUiService.GetTopAlliancesAthRankingsAsync(WorldId, _selectedLeague, DataLoadingCts.Token);
        IsLoading = false;
        StateHasChanged();
    }

    protected override string ViewAllUrl => FogUrlBuilder.PageRoutes.WorldAlliancesAth(WorldId);
}