@using Ingweland.Fog.Application.Client.Web.Analytics
@using Ingweland.Fog.Application.Client.Web.Analytics.Interfaces
@using Ingweland.Fog.Application.Client.Web.Localization
@using Ingweland.Fog.Application.Client.Web.Services.Abstractions
@using Ingweland.Fog.Dtos.Hoh
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<FogResource> Loc
@inject IFogSharingUiService FogSharingUiService
@inject IJSInteropService JSInteropService
@inject IAnalyticsService AnalyticsService
<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <LoadingIndicator Dense="true"/>
        }
        else if (_link != null)
        {
            <div class="share-link-container">
                <span>@_link</span>
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" OnClick="@CopyLink"/>
            </div>
        }
        else
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled"
                       OnClick="@Share">@Loc[FogResource.ShareDialog_ShareButton]</MudButton>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close">@Loc[FogResource.Common_Close]</MudButton>
    </DialogActions>
</MudDialog>

@code {

    private static readonly Dictionary<string, object> EmptyDict = new();
    
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    [EditorRequired]
    public required SharedDataDto Data { get; set; }

    [Parameter]
    [EditorRequired]
    public required string BaseUrl { get; set; }

    private bool _isLoading;

    private string? _link;

    private void Close()
    {
        MudDialog.Cancel();
    }

    private async Task Share()
    {
        try
        {
            _isLoading = true;

            _ = AnalyticsService.TrackEvent(AnalyticsEvents.CREATE_SHARED_LINK, EmptyDict);

            var sharingResult = await FogSharingUiService.ShareAsync(Data);

            _link = BaseUrl.Replace("{shareId}", sharingResult.Id);

            _ = AnalyticsService.TrackEvent(AnalyticsEvents.SHARED_LINK_CREATED, EmptyDict);
        }
        catch (Exception e)
        {
            _ = AnalyticsService.TrackEvent(AnalyticsEvents.SHARED_LINK_CREATION_ERROR, EmptyDict);
            Console.WriteLine(e);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CopyLink()
    {
        if (string.IsNullOrWhiteSpace(_link))
        {
            return;
        }

        _ = AnalyticsService.TrackEvent(AnalyticsEvents.SHARED_LINK_COPIED, EmptyDict);

        await JSInteropService.CopyToClipboardAsync(_link);
    }

}