@rendermode InteractiveWebAssembly
@using Ingweland.Fog.Application.Client.Web.CityPlanner.Abstractions
@using Ingweland.Fog.Application.Client.Web.CityPlanner.Stats
@using Ingweland.Fog.Application.Client.Web.Localization
@using Ingweland.Fog.Application.Client.Web.Services.Hoh.Abstractions
@using Ingweland.Fog.Application.Client.Web.ViewModels.Hoh
@using Ingweland.Fog.Models.Fog.Entities
@using Ingweland.Fog.Models.Hoh.Enums
@using Microsoft.Extensions.Localization
@implements IDisposable
@inject ICityPlanner CityPlanner
@inject IStringLocalizer<FogResource> Loc
@inject IToolsUiService ToolsUiService
<div class="fog-container component-root">
    <div class="age-label" style="background-color: @Data.Age.Color">@Data.Age.Name</div>
    <div class="header-container">@Data.Name</div>
    <div class="main-container">
        @if (CityPlanner.CityMapState.CityWonder != null)
        {
            <div class="wonder-level-selector-container">
                <span class="entity-title">@CityPlanner.CityMapState.CityWonder.WonderName</span>
                @if (Editable)
                {
                    <LevelSelectorComponent Levels="@_wonderLevelRange" LevelChanged="OnWonderLevelChanged"
                                            SelectedLevel="@Data.WonderLevel"/>
                }
                else
                {
                    @($"{Loc[FogResource.Hoh_Lvl]} {Data.WonderLevel}")
                }
            </div>

            <WonderCostComponent Items="@_wonderItems" Label="@_wonderCurrentLevelRange"/>
        }
        <CityProductionStatsComponent Items="@Data.Production.Products"/>
        @if (Data.Production.Costs.Count > 0)
        {
            <CityProductionStatsComponent Items="@Data.Production.Costs"
                                          Title="@Loc[FogResource.CityPlanner_ProductionCost]"/>
        }
        @if (CitiesWithHappiness.Contains(Data.CityId))
        {
            <HappinessStatsComponent Data="@Data.Happiness"/>
        }
        <CityAreaStatsComponent Data="@Data.Areas"/>
        <WorkforceStatsComponent Data="@Data.Workforce"/>
        @if(Data.WonderBonus != null)
        {
            <WonderBonusComponent Items="@Data.WonderBonus"/>
        }
    </div>
</div>

@code {

    private static readonly HashSet<CityId> CitiesWithHappiness =
        [CityId.Capital, CityId.Egypt, CityId.Mayas_Tikal, CityId.Mayas_ChichenItza, CityId.Mayas_SayilPalace,
        CityId.Arabia_CityOfBrass, CityId.Arabia_NoriasOfHama, CityId.Arabia_Petra];

    private readonly BuildingLevelRange _wonderLevelRange = new() {StartLevel = 0, EndLevel = 50};
    private string _wonderCurrentLevelRange = string.Empty;
    private IReadOnlyCollection<IconLabelItemViewModel> _wonderItems = [];

    protected override void OnInitialized()
    {
        CityPlanner.StateHasChanged += CityPlannerOnStateChanged;

        if (CityPlanner.CityMapState.CityWonder != null)
        {
            OnWonderLevelChanged(Data.WonderLevel);
        }
    }

    private void CityPlannerOnStateChanged()
    {
        StateHasChanged();
    }

    [Parameter]
    public bool Editable { get; set; } = true;

    [Parameter]
    public CityPlannerCityPropertiesViewModel Data { get; set; } = null!;

    public void Dispose()
    {
        CityPlanner.StateHasChanged -= CityPlannerOnStateChanged;
    }

    private void OnWonderLevelChanged(int level)
    {
        if (level < _wonderLevelRange.EndLevel)
        {
            _wonderCurrentLevelRange = $"{level} > {level + 1}";
            _wonderItems = ToolsUiService.CalculateWonderLevelsCost(CityPlanner.CityMapState.CityWonder!, level, level+1);
        }
        else
        {
            _wonderCurrentLevelRange = level.ToString();
            _wonderItems = [];
        }
        
        CityPlanner.UpdateWonderLevel(level);
    }

}